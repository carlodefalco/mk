#!/bin/bash

pkgname=openssl
pkgver=3.2.1
archive=$pkgname-$pkgver.tar.gz
sum=9668723d65d21a9d13e985203ce8c27ac5ecf3ae

dstdir=$mkToolchainBase

build() {
  download https://github.com/openssl/openssl/releases/download/$pkgname-$pkgver/$archive
  check $archive $sum
  extract $archive

  pushd $pkgname-$pkgver
    message "Configuring $pkgname"
    KERNEL_BITS=64 \
    ./config --prefix="$dstdir" --openssldir="$dstdir"/etc/ssl --libdir=lib \
             shared zlib-dynamic
    message "Compiling $pkgname"
    make
  popd
}

package() {
  # installing openssl
  make -C $pkgname-$pkgver MANDIR="$dstdir"/share/man MANSUFFIX=ssl install
  sed -i "1s:/usr/bin/perl:$(which perl):" "$dstdir"/bin/c_rehash
  sed -i "1s:/usr/bin/perl:$(which perl):" "$dstdir"/etc/ssl/misc/tsget

  # installing certificates
  if [[ ! "$mkTest" = "no" ]]; then
    export LD_LIBRARY_PATH="$dstdir"/lib
  else
    update_linker_cache
  fi
  install -d "$dstdir"/libexec/ssl
  sed -e "s:%PREFIX%:$dstdir:g" "$srcdir"/make-ca > "$dstdir"/libexec/ssl/make-ca
  chmod 0755 "$dstdir"/libexec/ssl/make-ca
  sed -i "1s:/bin/bash:$(which bash):" "$dstdir"/libexec/ssl/make-ca

  "$dstdir"/libexec/ssl/make-ca -f -g
  
  chmod u+w "$dstdir"/etc/ssl/certs
  ln -s "$dstdir"/etc/pki/tls/certs/ca-bundle.crt "$dstdir"/etc/ssl/certs/ca-bundle.crt
  ln -s "$dstdir"/etc/pki/tls/certs/ca-bundle.crt "$dstdir"/etc/ssl/certs/ca-certificates.crt
}
