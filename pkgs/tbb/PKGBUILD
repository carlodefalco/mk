#!/bin/bash

pkgname=tbb
pkgver=2020.1
archive=v$pkgver.tar.gz
sum=734f335d06ee80a7d4a20cc0da734c59
dstdir=$mkToolchainPkgs/$pkgname/$pkgver

build() {
  download https://github.com/oneapi-src/oneTBB/archive/$archive
  check $archive $sum
  extract $archive $pkgname-$pkgver

  pushd $pkgname-$pkgver
    message "Compiling $pkgname"
    make stdver=c++17 tbb_build_prefix=BUILDPREFIX
  popd
}

package() {
  install -vd $dstdir/{include,lib}

  install -v $pkgname-$pkgver/build/BUILDPREFIX_release/*.so.2 $dstdir/lib
  strip $dstdir/lib
  for name in tbb tbbmalloc tbbmalloc_proxy; do
    ln -sfv lib$name.so.2 $dstdir/lib/lib$name.so
  done

  pushd $pkgname-$pkgver/include
    tar -cf - tbb | (cd $dstdir/include && tar -xf -)
  popd

  if [[ "$mkTest" = "no" ]]; then
    install -vd $mkToolchainModules/$pkgname
    cat > $mkToolchainModules/$pkgname/$pkgver.lua << EOF
-- -*- lua -*-
whatis("Widely used C++ template library for task parallelism.")
help([[
The TBB library is installed in "\$mkTbbPrefix" directory, the dynamic libraries
are located in "\$mkTbbLib" directory and header files in "\$mkTbbInc".

url: https://software.intel.com/en-us/tbb
]])

setenv("mkTbbPrefix", "$dstdir")
setenv("mkTbbLib", "$dstdir/lib")
setenv("mkTbbInc", "$dstdir/include")

prepend_path("LD_LIBRARY_PATH", "$dstdir/lib")
EOF
  fi
}
